<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Token Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>GitHub Token Test</h1>
    <div id="status"></div>
    <button onclick="testTokenLoading()">Test Token Loading</button>
    <button onclick="testGitHubAPI()">Test GitHub API</button>
    <button onclick="testFileUpload()">Test File Upload</button>
    <div id="results"></div>

    <script>
        // Copy the GitHub config loading from your contract.html
        let GITHUB_CONFIG = {
            token: null,
            owner: 'cochranfilms',
            repo: 'cochran-job-listings',
            repoOwner: 'cochranfilms',
            repoName: 'cochran-job-listings',
            branch: 'main'
        };

        async function loadGitHubConfig() {
            try {
                const response = await fetch('config/github-config.json');
                if (response.ok) {
                    const config = await response.json();
                    GITHUB_CONFIG = {
                        token: config.githubToken,
                        owner: config.repoOwner || 'cochranfilms',
                        repo: config.repoName || 'cochran-job-listings',
                        repoOwner: config.repoOwner || 'cochranfilms',
                        repoName: config.repoName || 'cochran-job-listings',
                        branch: config.branch || 'main'
                    };
                    console.log('‚úÖ GitHub configuration loaded successfully');
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è Could not load GitHub config file, using fallback');
                    return false;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error loading GitHub config:', error);
                return false;
            }
        }

        function getGitHubToken() {
            // First try to get token from localStorage (for admin use)
            let token = localStorage.getItem('github_token');
            
            // If no local token, use the global token from config
            if (!token) {
                token = GITHUB_CONFIG.token;
                
                if (!token) {
                    console.warn('‚ö†Ô∏è GitHub token not configured. Please check config/github-config.json');
                    return null;
                }
            }
            
            return token;
        }

        function setGitHubToken(newToken) {
            localStorage.setItem('github_token', newToken);
            console.log('‚úÖ GitHub token updated securely');
        }

        function addStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            statusDiv.appendChild(div);
        }

        async function testTokenLoading() {
            addStatus('üîÑ Testing token loading...', 'warning');
            
            try {
                const loaded = await loadGitHubConfig();
                const token = getGitHubToken();
                
                if (loaded && token) {
                    addStatus('‚úÖ Token loaded successfully!', 'success');
                    addStatus(`Token: ${token.substring(0, 10)}...${token.substring(token.length - 4)}`, 'success');
                } else if (token) {
                    addStatus('‚ö†Ô∏è Config file not loaded, but token found in localStorage', 'warning');
                } else {
                    addStatus('‚ùå No token found', 'error');
                }
            } catch (error) {
                addStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testGitHubAPI() {
            addStatus('üîÑ Testing GitHub API...', 'warning');
            
            try {
                const token = getGitHubToken();
                if (!token) {
                    addStatus('‚ùå No token available for API test', 'error');
                    return;
                }

                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    addStatus(`‚úÖ GitHub API working! User: ${user.login}`, 'success');
                } else {
                    const error = await response.json();
                    addStatus(`‚ùå GitHub API error: ${error.message}`, 'error');
                }
            } catch (error) {
                addStatus(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function testFileUpload() {
            addStatus('üîÑ Testing file upload...', 'warning');
            
            try {
                const token = getGitHubToken();
                if (!token) {
                    addStatus('‚ùå No token available for upload test', 'error');
                    return;
                }

                const testData = {
                    message: 'Test upload from contract system',
                    content: btoa('Test content from contract system'),
                    branch: GITHUB_CONFIG.branch
                };

                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/test-contract-upload.txt`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const result = await response.json();
                    addStatus('‚úÖ File upload successful!', 'success');
                    addStatus(`File URL: ${result.content.html_url}`, 'success');
                    
                    // Clean up the test file
                    setTimeout(async () => {
                        try {
                            const deleteResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/test-contract-upload.txt`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `token ${token}`,
                                    'Accept': 'application/vnd.github.v3+json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: 'Clean up test file',
                                    sha: result.content.sha
                                })
                            });
                            
                            if (deleteResponse.ok) {
                                addStatus('‚úÖ Test file cleaned up', 'success');
                            }
                        } catch (cleanupError) {
                            addStatus(`‚ö†Ô∏è Could not clean up test file: ${cleanupError.message}`, 'warning');
                        }
                    }, 2000);
                    
                } else {
                    const error = await response.json();
                    addStatus(`‚ùå Upload error: ${error.message}`, 'error');
                }
            } catch (error) {
                addStatus(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        // Load config on page load
        document.addEventListener('DOMContentLoaded', async function() {
            addStatus('üîÑ Loading GitHub configuration...', 'warning');
            await loadGitHubConfig();
            addStatus('‚úÖ Page loaded, ready for testing', 'success');
        });
    </script>
</body>
</html> 